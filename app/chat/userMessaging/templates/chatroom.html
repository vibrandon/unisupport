{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <!-- Chat Header -->
  <div class="card shadow-sm mb-3">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">
          <i class="bi bi-chat-dots me-2"></i>Chat with {{ chat_partner.firstname }} {{ chat_partner.lastname }}
        </h5>
        <small class="text-muted">{{ chat_partner.email }}</small>
      </div>
      <a href="{{ url_for('chat_bp.chat')}}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back
      </a>
    </div>
  </div>

  <!-- Chat Body -->
  <div class="card shadow-sm">
    <div class="card-body p-3" id="chat-container" style="height: 60vh; overflow-y: auto;">
      {% for msg in messages %}
        <div class="d-flex mb-3 {% if msg.sender_id == current_user.id %}justify-content-end{% else %}justify-content-start{% endif %}">
          <div class="p-2 rounded {% if msg.sender_id == current_user.id %}bg-primary text-white{% else %}bg-light{% endif %}" style="max-width: 70%;">
            <div>{{ msg.content }}</div>
            <small class="text-muted d-block text-end mt-1" style="font-size: 0.75rem;">
              {{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }}
            </small>
          </div>
        </div>
      {% else %}
        <p class="text-muted text-center">No messages yet. Say hi!</p>
      {% endfor %}
    </div>

    <!-- Chat Input -->
    <div class="card-footer bg-light">
      <form method="POST" action="{{ url_for('user_msg_bp.send_message') }}" class="d-flex">
        <input type="hidden" name="receiver_id" value="{{ chat_partner.id }}">
        <input type="text" name="content" class="form-control me-2" placeholder="Type a message..." required>
        <button class="btn btn-primary" type="submit">
          <i class="bi bi-send-fill"></i>
        </button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Auto-scroll to bottom on page load
  const chatContainer = document.getElementById("chat-container");
  if (chatContainer) {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
</script>
{% endblock %}
